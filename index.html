<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ­ Actor's Tool V2</title>
    <meta name="theme-color" content="#7c3aed">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Actor's Tool">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%237c3aed'/><text x='50' y='70' font-size='60' text-anchor='middle'>ğŸ­</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script>tailwind.config={darkMode:'class'};pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <style>
        .scrollbar-thin::-webkit-scrollbar{width:6px;height:6px}
        .scrollbar-thin::-webkit-scrollbar-thumb{background:#a855f7;border-radius:3px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .animate-spin{animation:spin 1s linear infinite}
        .line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
        .frag-move{background:#dbeafe;border-color:#60a5fa;color:#1e40af}
        .frag-dial{background:#dcfce7;border-color:#4ade80;color:#166534}
        .frag-emot{background:#ffedd5;border-color:#fb923c;color:#9a3412}
        .frag-inter{background:#f3e8ff;border-color:#c084fc;color:#6b21a8}
        .dark .frag-move{background:#1e3a5f;color:#93c5fd}
        .dark .frag-dial{background:#14532d;color:#86efac}
        .dark .frag-emot{background:#7c2d12;color:#fed7aa}
        .dark .frag-inter{background:#4c1d95;color:#e9d5ff}
        .choice-item{transition:all 0.2s ease}
        .choice-item:hover{transform:translateX(2px)}
        .sub-choice-panel{animation:slideDown 0.2s ease}
        @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
        .fullscreen-modal{position:fixed;inset:0;z-index:100;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;padding:1rem}
        .fullscreen-content{background:white;border-radius:1rem;width:100%;max-width:90vw;max-height:90vh;overflow:auto;position:relative}
        .dark .fullscreen-content{background:#1f2937}
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-50 via-indigo-50 to-pink-50 dark:bg-gray-900">
<div id="app"></div>
<script>
const LANG={nl:'Nederlands',en:'English',es:'EspaÃ±ol',fr:'FranÃ§ais',de:'Deutsch',it:'Italiano',pt:'PortuguÃªs',ru:'Ğ ÑƒÑÑĞºĞ¸Ğ¹',ja:'æ—¥æœ¬èª',zh:'ä¸­æ–‡',ko:'í•œêµ­ì–´',ar:'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',tr:'TÃ¼rkÃ§e',pl:'Polski',sv:'Svenska',hi:'à¤¹à¤¿à¤¨à¥à¤¦à¥€',th:'à¹„à¸—à¸¢',vi:'Tiáº¿ng Viá»‡t',id:'Bahasa Indonesia',he:'×¢×‘×¨×™×ª'};
const BUILD=['Slank','Atletisch','Gemiddeld','Gespierd','Zwaar'];
const RELATION=['Partner/geliefde','Familie','Vriend','Collega','Kennis','Vreemde','Vijand','Autoriteit','Ondergeschikte'];
const POWER=['Jij hebt meer macht','Gelijkwaardig','De ander heeft meer macht','Wisselend/onduidelijk'];
const HISTORY=['Geen (eerste ontmoeting)','Kort (recent ontmoet)','Gemiddeld (kennen elkaar een tijdje)','Lang (jaren van geschiedenis)','Intens (veel meegemaakt samen)'];
const EMOTION=['Positief','Negatief','Neutraal','Gemengd/ambivalent'];
const WHERE=['Thuis','Werk','Openbaar','Buiten','Vervoer','Instituut','Horeca'];
const WHENTIME=['Ochtend','Middag','Avond','Nacht'];
const WHENSEASON=['Lente','Zomer','Herfst','Winter'];
const ATMOS=['Gezellig','Gespannen','Intiem','Kil','Chaotisch','Neutraal'];
const METHODS=[
{id:'stanislavski',name:'Stanislavski System',desc:'Emotional memory and given circumstances'},
{id:'method',name:'Method Acting (Strasberg)',desc:'Deep emotional immersion'},
{id:'meisner',name:'Meisner Technique',desc:'Living truthfully under imaginary circumstances'},
{id:'practical',name:'Practical Aesthetics',desc:'Action-based approach (Mamet)'},
{id:'chekhov',name:'Chekhov Technique',desc:'Psychological gesture and imagination'},
{id:'adler',name:'Stella Adler',desc:'Imagination over emotional memory'},
{id:'hagen',name:'Uta Hagen',desc:'Substitution and transference'},
{id:'viewpoints',name:'Viewpoints',desc:'Space, time, and movement awareness'},
{id:'suzuki',name:'Suzuki Method',desc:'Physical training and energy from feet'},
{id:'grotowski',name:'Grotowski',desc:'Poor theatre, via negativa'},
{id:'brecht',name:'Brecht Verfremdungseffekt',desc:'Alienation effect, epic theatre'},
{id:'commedia',name:"Commedia dell'Arte",desc:'Stock characters and improvisation'},
{id:'physical',name:'Physical Theatre',desc:'Body as primary instrument'},
{id:'biomechanics',name:'Biomechanics (Meyerhold)',desc:'Precise physical actions'},
{id:'alba',name:'Alba Emoting',desc:'Breathing patterns create emotions'},
{id:'laban',name:'Laban Movement Analysis',desc:'Effort, shape, space, body'},
{id:'alexander',name:'Alexander Technique',desc:'Releasing tension, conscious control'},
{id:'feldenkrais',name:'Feldenkrais',desc:'Awareness through movement'},
{id:'bogart',name:'Anne Bogart',desc:'Viewpoints and composition'},
{id:'morris',name:'Eric Morris',desc:'Being over acting'},
{id:'rodenburg',name:'Patsy Rodenburg',desc:'Voice and presence circles'},
{id:'linklater',name:'Kristin Linklater',desc:'Freeing the natural voice'},
{id:'spolin',name:'Viola Spolin',desc:'Theatre games and improvisation'},
{id:'johnstone',name:'Keith Johnstone',desc:'Status and spontaneity'},
{id:'lecoq',name:'Jacques Lecoq',desc:'Movement, mime, and play'},
{id:'suzuki2',name:'Tadashi Suzuki Extended',desc:'Speaking from the feet'},
{id:'grotowski2',name:'Grotowski Extended',desc:'Total act, performer as shaman'},
{id:'gesture',name:'Psychological Gesture',desc:'Full body character expression'},
{id:'neutral',name:'Neutral Mask',desc:'Finding economy of movement'},
{id:'rasaboxes',name:'Rasaboxes',desc:'Indian emotion system (9 rasas)'}
];
const FRAG={movement:{c:'frag-move',l:'Beweging',i:'ğŸ”µ'},dialogue:{c:'frag-dial',l:'Dialoog',i:'ğŸŸ¢'},emotion:{c:'frag-emot',l:'Emotie',i:'ğŸŸ '},interaction:{c:'frag-inter',l:'Interactie',i:'ğŸŸ£'}};
const CATS=[{id:'normal',l:'Normaal',i:'âœ…'},{id:'exceptional',l:'Uitzonderlijk',i:'â­'},{id:'extreme',l:'Extreem',i:'ğŸ”¥'},{id:'comedic',l:'Komisch',i:'ğŸ˜„'},{id:'dramatic',l:'Dramatisch',i:'ğŸ­'},{id:'minimal',l:'Minimalistisch',i:'ğŸ¤«'}];

const defaultState = ()=>({
lang:'nl',apiKey:localStorage.getItem('at_key')||'',dark:localStorage.getItem('at_dark')==='true',onboard:!localStorage.getItem('at_done'),
actor:{name:'',age:'',height:'',weight:'',build:'',notes:''},
chars:[{id:1,name:'',age:'',isMain:true,rel:'',relC:'',pow:'',powC:'',hist:'',histC:'',emo:'',emoC:'',traits:''}],
ctx:{who:'',what:'',where:'',whereC:'',whereD:'',whenT:'',whenTC:'',whenS:'',whenSC:'',whenD:'',why:'',atmos:'',atmosC:'',env:''},
scenes:[],sceneIn:'',
analysis:null,methods:[],methodMode:'optional',
frags:[],selFrag:null,fragFilter:'all',
choices:{},choiceAmt:50,showOpp:false,
subChoices:{},selectedChoice:null,loadingSub:false,
favs:[],notes:{},
secret:'',secretList:[],secretExpanded:false,
chat:[],chatIn:'',goals:[],
wildcard:[],wildcardExp:false,famous:[],famousExp:false,
rehTime:120,rehActive:false,rehInt:null,
loading:false,loadMsg:'',collapsed:{},expanded:{},
fullscreen:null,sceneExpanded:{}
});

let S = defaultState();
let profiles = JSON.parse(localStorage.getItem('at_profiles')||'[]');

try{const x=localStorage.getItem('at_state');if(x){const p=JSON.parse(x);S={...defaultState(),...p,loading:false,rehActive:false,loadingSub:false,fullscreen:null}}}catch(e){}
if(S.dark)document.documentElement.classList.add('dark');

function save(){const t={...S};delete t.loading;delete t.loadMsg;delete t.rehInt;delete t.loadingSub;delete t.fullscreen;localStorage.setItem('at_state',JSON.stringify(t))}
function esc(t){return t?String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'):''}
function togDark(){S.dark=!S.dark;document.documentElement.classList.toggle('dark',S.dark);localStorage.setItem('at_dark',S.dark);render()}
function togCol(id){S.collapsed[id]=!S.collapsed[id];render()}
function isOpen(id,d=true){return S.collapsed[id]===undefined?d:!S.collapsed[id]}

// PROFILES
function saveProfile(){
const name=prompt('Naam voor dit profiel:');
if(!name)return;
const data={...S,name,savedAt:new Date().toISOString()};
delete data.loading;delete data.loadMsg;delete data.rehInt;delete data.loadingSub;delete data.fullscreen;
const existing=profiles.findIndex(p=>p.name===name);
if(existing>=0){if(confirm('Profiel "'+name+'" bestaat al. Overschrijven?'))profiles[existing]=data;else return;}
else profiles.push(data);
localStorage.setItem('at_profiles',JSON.stringify(profiles));
alert('Profiel "'+name+'" opgeslagen!');render();
}
function loadProfile(name){
const p=profiles.find(x=>x.name===name);
if(!p)return;
if(!confirm('Huidig werk wordt vervangen door profiel "'+name+'". Doorgaan?'))return;
S={...defaultState(),...p,loading:false,rehActive:false,loadingSub:false,fullscreen:null,apiKey:S.apiKey,dark:S.dark};
save();render();
}
function deleteProfile(name){
if(!confirm('Profiel "'+name+'" verwijderen?'))return;
profiles=profiles.filter(p=>p.name!==name);
localStorage.setItem('at_profiles',JSON.stringify(profiles));
render();
}
function newProject(){
if(!confirm('Alles wissen en opnieuw beginnen?'))return;
const apiKey=S.apiKey,dark=S.dark;
S=defaultState();S.apiKey=apiKey;S.dark=dark;S.onboard=false;
save();render();
}

// FULLSCREEN
function openFullscreen(type){S.fullscreen=type;render()}
function closeFullscreen(){S.fullscreen=null;render()}

function addChar(){if(S.chars.length>=6)return;S.chars.push({id:Date.now(),name:'',age:'',isMain:false,rel:'',relC:'',pow:'',powC:'',hist:'',histC:'',emo:'',emoC:'',traits:''});save();render()}
function remChar(id){if(S.chars.length<=1)return;S.chars=S.chars.filter(c=>c.id!==id);save();render()}
function updChar(id,f,v){const c=S.chars.find(x=>x.id===id);if(c){c[f]=v;save()}}

function addScene(){const t=S.sceneIn.trim();if(!t)return;S.scenes.push({id:Date.now(),text:t,src:'paste'});S.sceneIn='';save();render()}
function remScene(id){S.scenes=S.scenes.filter(s=>s.id!==id);save();render()}
function toggleSceneExp(id){S.sceneExpanded[id]=!S.sceneExpanded[id];render()}

async function handleFiles(e){
const files=Array.from(e.target.files);if(!files.length)return;
S.loading=true;S.loadMsg='Bestanden inlezen...';render();
for(let i=0;i<files.length;i++){
const file=files[i];
S.loadMsg='Bestand '+(i+1)+'/'+files.length+': '+file.name;render();
const ext=file.name.split('.').pop().toLowerCase();
try{
let text='';
if(ext==='txt'){text=await new Promise((res,rej)=>{const r=new FileReader();r.onload=ev=>res(ev.target.result);r.onerror=rej;r.readAsText(file);});}
else if(ext==='pdf'){
const buf=await new Promise((res,rej)=>{const r=new FileReader();r.onload=ev=>res(ev.target.result);r.onerror=rej;r.readAsArrayBuffer(file);});
const pdf=await pdfjsLib.getDocument(new Uint8Array(buf)).promise;
let t='';for(let p=1;p<=pdf.numPages;p++){const pg=await pdf.getPage(p);const c=await pg.getTextContent();t+=c.items.map(x=>x.str).join(' ')+'\n\n';}
text=t.trim();
}
else if(ext==='docx'){
const buf=await new Promise((res,rej)=>{const r=new FileReader();r.onload=ev=>res(ev.target.result);r.onerror=rej;r.readAsArrayBuffer(file);});
const result=await mammoth.extractRawText({arrayBuffer:buf});
text=result.value;
}
if(text.trim())S.scenes.push({id:Date.now()+i,text:text.trim(),src:ext,name:file.name});
}catch(err){alert('Fout bij '+file.name+': '+err.message);}
}
S.loading=false;save();render();e.target.value='';
}

async function callAI(p){
if(!S.apiKey){alert('Voer eerst je Claude API key in!');return null}
try{
const r=await fetch('https://actingtool.ferencsomogyi.workers.dev/v1/messages',{
method:'POST',headers:{'Content-Type':'application/json','x-api-key':S.apiKey,'anthropic-version':'2023-06-01'},
body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:4096,messages:[{role:'user',content:p}]})
});
if(!r.ok)throw new Error('API Error: '+r.status);
const d=await r.json();return d.content[0].text;
}catch(e){alert('Fout: '+e.message);return null}
}

async function analyze(){
if(S.scenes.length===0){alert('Voeg eerst een scene toe!');return}
S.loading=true;S.loadMsg='Analyseren...';render();
const txt=S.scenes.map((s,i)=>'SCENE '+(i+1)+':\n'+s.text).join('\n\n');
const mainChar=S.chars.find(c=>c.isMain)||S.chars[0];
const otherChars=S.chars.filter(c=>!c.isMain);
const chars=otherChars.map(c=>'- '+(c.name||'?')+': rel='+(c.rel||c.relC||'?')+', macht='+(c.pow||c.powC||'?')).join('\n');
const p=`Je bent een expert acteercoach. Analyseer in het ${LANG[S.lang]}.

ACTOR: ${S.actor.name||'?'}, ${S.actor.age||'?'} jaar, ${S.actor.build||'?'}
${S.actor.notes?'Bijzonderheden: '+S.actor.notes:''}

MIJN PERSONAGE: ${mainChar.name||'Hoofdpersonage'}, ${mainChar.age||'?'} jaar
Eigenschappen: ${mainChar.traits||'-'}

ANDERE PERSONAGES:
${chars||'Geen'}

CONTEXT:
Wie: ${S.ctx.who||'-'} | Wat: ${S.ctx.what||'-'} | Waar: ${S.ctx.where||S.ctx.whereC||'-'} | Wanneer: ${S.ctx.whenT||''} ${S.ctx.whenS||''} | Waarom: ${S.ctx.why||'-'}

SCENE(S):
${txt}

Geef analyse met 12 punten:
1. Scene breakdown 2. Emotionele arc 3. Actiemomenten 4. Conflict 5. Subtext 6. Relatie dynamiek 7. Omstandigheden 8. Obstacles 9. Keerpunten 10. Stakes 11. Tactiek 12. Geheimen

Wees specifiek en praktisch.`;
const res=await callAI(p);
if(res){S.analysis=res;save();await extractFrags()}
S.loading=false;render();
}

async function extractFrags(){
S.loadMsg='Fragmenten...';render();
const txt=S.scenes.map(s=>s.text).join('\n');
const p=`Extraheer ALLE speelbare fragmenten. CategorieÃ«n: movement, dialogue, emotion, interaction
Return ALLEEN JSON: [{"text":"...", "type":"movement"}, ...]
Minimum 10 fragmenten.

SCENE:
${txt}`;
const res=await callAI(p);
if(res){try{S.frags=JSON.parse(res.replace(/```json|```/g,'').trim()).map((f,i)=>({...f,id:i}));save()}catch(e){S.frags=[]}}
}

async function genChoices(frag){
S.selFrag=frag;S.loading=true;S.loadMsg='Keuzes genereren...';render();
const meth=S.methods.length?S.methods.map(id=>METHODS.find(m=>m.id===id)?.name).join(', '):'Geen';
const mainChar=S.chars.find(c=>c.isMain)||S.chars[0];
const p=`Genereer ${S.choiceAmt} acteer-keuzes in het ${LANG[S.lang]}.

ACTOR: ${S.actor.name||'?'}
PERSONAGE: ${mainChar.name||'Hoofdpersonage'}
${S.secret?'GEHEIM dat personage meedraagt: '+S.secret:''}
METHODE: ${meth}

FRAGMENT: "${frag.text}"
TYPE: ${frag.type}

CategorieÃ«n: normal, exceptional, extreme, comedic, dramatic, minimal

Return JSON:
{"normal":["..."],"exceptional":[...],"extreme":[...],"comedic":[...],"dramatic":[...],"minimal":[...]}`;
const res=await callAI(p);
if(res){try{S.choices[frag.id]=JSON.parse(res.replace(/```json|```/g,'').trim());save()}catch(e){}}
S.loading=false;render();
}

async function genSubChoices(choice,cat){
const choiceKey=typeof choice==='object'?choice.choice:choice;
S.loadingSub=true;S.selectedChoice=choiceKey;render();
const p=`Expert acteercoach. Acteur koos: "${choiceKey}"
FRAGMENT: "${S.selFrag?.text||''}"
${S.secret?'GEHEIM: '+S.secret:''}

Geef 10 ZEER GEDETAILLEERDE sub-variaties. EXTREEM SPECIFIEK over:
- Exacte lichaamshouding, timing, blik, ademhaling, micro-bewegingen

Return ALLEEN JSON array met 10 strings in ${LANG[S.lang]}:
["sub 1...", "sub 2...", ...]`;
const res=await callAI(p);
if(res){try{S.subChoices[choiceKey]=JSON.parse(res.replace(/```json|```/g,'').trim())||[];save()}catch(e){S.subChoices[choiceKey]=[]}}
S.loadingSub=false;render();
}

function toggleChoiceExpand(choiceKey){S.selectedChoice=S.selectedChoice===choiceKey?null:choiceKey;render()}

// WILD CARD
async function wildCard(){
if(!S.selFrag){alert('Selecteer eerst een fragment!');return}
S.loading=true;S.loadMsg='Wild Card... ğŸƒ';render();
const p=`15 ABSURDE, BIZARRE acteer-keuzes voor: "${S.selFrag.text}"
Artaud, Grotowski, absurdisme. Return JSON: [{"choice":"...","why":"..."},...]`;
const res=await callAI(p);
if(res){try{S.wildcard=JSON.parse(res.replace(/```json|```/g,'').trim());S.wildcardExp=true;save()}catch(e){}}
S.loading=false;render();
}

// FAMOUS
async function famous(){
if(!S.selFrag){alert('Selecteer eerst een fragment!');return}
S.loading=true;S.loadMsg='Beroemde keuzes... â­';render();
const p=`10 ICONISCHE keuzes van beroemde acteurs voor: "${S.selFrag.text}"
Return JSON: [{"actor":"...","film":"...","choice":"..."},...]`;
const res=await callAI(p);
if(res){try{S.famous=JSON.parse(res.replace(/```json|```/g,'').trim());S.famousExp=true;save()}catch(e){}}
S.loading=false;render();
}

// GEHEIM GENERATOR
async function genSecrets(){
if(S.scenes.length===0){alert('Voeg eerst een scene toe!');return}
S.loading=true;S.loadMsg='Geheimen genereren... ğŸ”’';render();
const mainChar=S.chars.find(c=>c.isMain)||S.chars[0];
const p=`Genereer 20 interessante GEHEIMEN die een personage kan meedragen tijdens deze scene.
Geheimen die de scene spannender maken, subtekst toevoegen, of het gedrag beÃ¯nvloeden.

PERSONAGE: ${mainChar.name||'Hoofdpersonage'}
SCENE: ${S.scenes.map(s=>s.text).join('\n').substring(0,1000)}

Mix van:
- Relationele geheimen (verliefd, haat, verraad)
- Fysieke geheimen (ziek, zwanger, pijn)
- Emotionele geheimen (angst, schuld, schaamte)
- Situationele geheimen (weet iets, liegt, plant iets)

Return ALLEEN JSON array met 20 strings in ${LANG[S.lang]}:
["geheim 1", "geheim 2", ...]`;
const res=await callAI(p);
if(res){try{S.secretList=JSON.parse(res.replace(/```json|```/g,'').trim())||[];S.secretExpanded=true;save()}catch(e){S.secretList=[]}}
S.loading=false;render();
}

function selectSecret(s){S.secret=s;S.secretExpanded=false;save();render()}

async function askChat(){
const q=S.chatIn.trim();if(!q)return;
S.chat.push({role:'user',c:q});S.chatIn='';S.loading=true;S.loadMsg='AI denkt...';render();
const p=`Acteercoach. Context: ${S.analysis?S.analysis.substring(0,800):'Geen'}
Fragment: ${S.selFrag?.text||'Geen'}
Vraag: ${q}
Antwoord in ${LANG[S.lang]}.`;
const res=await callAI(p);
if(res){S.chat.push({role:'ai',c:res});save()}
S.loading=false;render();
}

function togFav(ch,cat){
const t=typeof ch==='object'?ch.choice:ch;
const i=S.favs.findIndex(f=>f.choice===t);
if(i>=0)S.favs.splice(i,1);else S.favs.push({choice:t,cat,frag:S.selFrag?.text||'',ts:Date.now()});
save();render();
}
function isFav(ch){const t=typeof ch==='object'?ch.choice:ch;return S.favs.some(f=>f.choice===t)}

function addGoal(){const t=prompt('Doelstelling:');if(t){S.goals.push({id:Date.now(),t,done:false});save();render()}}
function togGoal(id){const g=S.goals.find(x=>x.id===id);if(g){g.done=!g.done;save();render()}}
function remGoal(id){S.goals=S.goals.filter(g=>g.id!==id);save();render()}

function startReh(){S.rehActive=true;S.rehInt=setInterval(()=>{S.rehTime--;if(S.rehTime<=0){stopReh();alert('â° Tijd!')}render()},1000);render()}
function stopReh(){S.rehActive=false;if(S.rehInt){clearInterval(S.rehInt);S.rehInt=null}render()}
function resetReh(s=120){stopReh();S.rehTime=s;render()}

// EXPORT DOCUMENT
function exportDoc(){
const mainChar=S.chars.find(c=>c.isMain)||S.chars[0];
let doc=`ACTOR'S TOOL - SESSIE EXPORT
============================
Datum: ${new Date().toLocaleString('nl-NL')}

ACTEUR
------
Naam: ${S.actor.name||'-'}
Leeftijd: ${S.actor.age||'-'}
Lengte: ${S.actor.height||'-'} cm
Gewicht: ${S.actor.weight||'-'} kg
Postuur: ${S.actor.build||'-'}
Bijzonderheden: ${S.actor.notes||'-'}

MIJN PERSONAGE
--------------
Naam: ${mainChar.name||'-'}
Leeftijd: ${mainChar.age||'-'}
Eigenschappen: ${mainChar.traits||'-'}

ANDERE PERSONAGES
-----------------
${S.chars.filter(c=>!c.isMain).map(c=>`- ${c.name||'?'}: ${c.rel||c.relC||'-'}`).join('\n')||'Geen'}

CONTEXT (5 W\'s)
---------------
WIE: ${S.ctx.who||'-'}
WAT: ${S.ctx.what||'-'}
WAAR: ${S.ctx.where||S.ctx.whereC||'-'} ${S.ctx.whereD||''}
WANNEER: ${S.ctx.whenT||''} ${S.ctx.whenS||''} ${S.ctx.whenD||''}
WAAROM: ${S.ctx.why||'-'}
SFEER: ${S.ctx.atmos||S.ctx.atmosC||'-'}

GEHEIM
------
${S.secret||'Geen geheim geselecteerd'}

SCENE(S)
--------
${S.scenes.map((s,i)=>`Scene ${i+1}${s.name?' ('+s.name+')':''}:\n${s.text}`).join('\n\n')||'Geen scenes'}

ANALYSE
-------
${S.analysis||'Geen analyse'}

FRAGMENTEN & KEUZES
-------------------
${S.frags.map(f=>{
const ch=S.choices[f.id];
if(!ch)return`Fragment: "${f.text}" - Geen keuzes`;
let txt=`Fragment: "${f.text}"\n`;
CATS.forEach(cat=>{
const items=ch[cat.id]||[];
if(items.length)txt+=`  ${cat.l}: ${items.slice(0,5).map(x=>typeof x==='object'?x.choice:x).join('; ')}${items.length>5?'...':''}\n`;
});
return txt;
}).join('\n')}

FAVORIETEN
----------
${S.favs.map(f=>`â˜… ${f.choice}`).join('\n')||'Geen'}

DOELSTELLINGEN
--------------
${S.goals.map(g=>`${g.done?'âœ“':'â—‹'} ${g.t}`).join('\n')||'Geen'}

NOTITIES
--------
${Object.entries(S.notes).filter(([k,v])=>v).map(([k,v])=>`${S.frags.find(f=>f.id==k)?.text||'?'}: ${v}`).join('\n')||'Geen'}
`;
const b=new Blob([doc],{type:'text/plain;charset=utf-8'});
const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='actors-tool-sessie-'+new Date().toISOString().slice(0,10)+'.txt';a.click();
}

function exportJSON(){
const d={date:new Date().toISOString(),actor:S.actor,chars:S.chars,ctx:S.ctx,scenes:S.scenes,analysis:S.analysis,frags:S.frags,choices:S.choices,subChoices:S.subChoices,favs:S.favs,notes:S.notes,goals:S.goals,secret:S.secret};
const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='actors-tool-'+Date.now()+'.json';a.click();
}

function closeOnboard(){S.onboard=false;localStorage.setItem('at_done','1');render()}

function dd(id,v,cv,opts,chg,chgC,ph='Selecteer...'){
let h='<select onchange="'+chg+'" class="w-full px-2 py-1 text-sm border rounded bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"><option value="">'+ph+'</option>';
opts.forEach(o=>{h+='<option value="'+esc(o)+'"'+(v===o?' selected':'')+'>'+esc(o)+'</option>'});
h+='<option value="_other"'+(v==='_other'?' selected':'')+'>Anders...</option></select>';
if(v==='_other')h+='<input type="text" value="'+esc(cv)+'" onchange="'+chgC+'" placeholder="Vul in..." class="w-full mt-1 px-2 py-1 text-sm border rounded bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">';
return h;
}

function sec(id,title,icon,content,badge='',def=true,fullscreenBtn=false){
const op=isOpen(id,def);
return '<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border dark:border-gray-700 mb-4">'+
'<div class="flex items-center justify-between px-4 py-3 bg-gray-50 dark:bg-gray-700 rounded-t-xl">'+
'<button onclick="togCol(\''+id+'\')" class="flex-1 flex items-center gap-2 text-left">'+
'<span>'+icon+'</span><span class="font-semibold dark:text-gray-200">'+title+'</span>'+(badge?'<span class="px-2 py-0.5 bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 text-xs rounded-full">'+badge+'</span>':'')+'</button>'+
'<div class="flex items-center gap-1">'+(fullscreenBtn?'<button onclick="openFullscreen(\''+id+'\')" class="p-1 hover:bg-gray-200 dark:hover:bg-gray-600 rounded text-gray-500" title="Fullscreen">ğŸ”²</button>':'')+'<span class="text-gray-500 cursor-pointer" onclick="togCol(\''+id+'\')">'+(op?'â–²':'â–¼')+'</span></div></div>'+(op?'<div class="p-4">'+content+'</div>':'')+'</div>';
}

function renderChoice(c,cat){
const t=typeof c==='object'?c.choice:c;
const isSelected=S.selectedChoice===t;
const hasSubs=S.subChoices[t]&&S.subChoices[t].length>0;
const isLoadingThis=S.loadingSub&&S.selectedChoice===t;

let h='<div class="choice-item border rounded-lg overflow-hidden '+(isSelected?'border-purple-500 border-2 shadow-md':'border-gray-200 dark:border-gray-600')+'">';
h+='<div class="p-2 bg-gray-50 dark:bg-gray-700 flex justify-between items-start gap-2 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" onclick="toggleChoiceExpand(\''+esc(t).replace(/'/g,"\\'")+'\')">';
h+='<div class="flex-1"><p class="text-sm dark:text-gray-200">'+esc(t)+'</p></div>';
h+='<div class="flex items-center gap-1">';
h+='<button onclick="event.stopPropagation();togFav(\''+esc(t).replace(/'/g,"\\'")+'\',\''+cat+'\')" class="p-1 '+(isFav(c)?'text-red-500':'text-gray-400')+'">'+(isFav(c)?'â¤ï¸':'ğŸ¤')+'</button>';
h+='<span class="text-purple-500 text-sm">'+(isSelected?'â–¼':'â–¶')+'</span></div></div>';

if(isSelected){
h+='<div class="sub-choice-panel bg-purple-50 dark:bg-purple-900/30 border-t border-purple-200 dark:border-purple-700 p-3">';
h+='<div class="flex items-center justify-between mb-2"><span class="text-xs font-semibold text-purple-700 dark:text-purple-300">ğŸ” Sub-keuzes</span>';
if(!hasSubs&&!isLoadingThis)h+='<button onclick="event.stopPropagation();genSubChoices(\''+esc(t).replace(/'/g,"\\'")+'\',\''+cat+'\')" class="px-3 py-1 bg-purple-600 text-white text-xs rounded-lg hover:bg-purple-700">âœ¨ Genereer 10</button>';
h+='</div>';
if(isLoadingThis)h+='<div class="flex items-center gap-2 py-4 justify-center"><div class="w-5 h-5 border-2 border-purple-600 border-t-transparent rounded-full animate-spin"></div><span class="text-sm text-purple-600">Laden...</span></div>';
else if(hasSubs){
h+='<div class="space-y-1 max-h-48 overflow-y-auto scrollbar-thin">';
S.subChoices[t].forEach((sub,i)=>{
h+='<div class="flex items-start gap-2 p-2 bg-white dark:bg-gray-800 rounded border border-purple-100 dark:border-purple-800">';
h+='<span class="text-purple-400 text-xs font-bold">'+(i+1)+'.</span>';
h+='<p class="text-xs text-gray-700 dark:text-gray-300 flex-1">'+esc(sub)+'</p>';
h+='<button onclick="event.stopPropagation();togFav(\''+esc(sub).replace(/'/g,"\\'")+'\',\'sub\')" class="text-sm '+(isFav(sub)?'text-red-500':'text-gray-400')+'">'+(isFav(sub)?'â¤ï¸':'ğŸ¤')+'</button></div>';
});
h+='</div><button onclick="event.stopPropagation();genSubChoices(\''+esc(t).replace(/'/g,"\\'")+'\',\''+cat+'\')" class="mt-2 w-full py-1 bg-gray-200 dark:bg-gray-700 text-xs rounded">ğŸ”„ Opnieuw</button>';
}else h+='<p class="text-xs text-gray-500 italic py-2">Klik knop voor 10 sub-variaties</p>';
h+='</div>';}
h+='</div>';
return h;
}

function renderFullscreen(){
if(!S.fullscreen)return'';
let content='',title='';

if(S.fullscreen==='ana'){
title='ğŸ§  Analyse';
content='<div class="whitespace-pre-wrap text-sm p-6">'+esc(S.analysis||'Geen analyse')+'</div>';
}
else if(S.fullscreen==='choices'){
title='âœ¨ Keuzes & Sub-keuzes';
content='<div class="p-6 space-y-4">';
if(S.selFrag){
content+='<p class="text-purple-600 font-medium">"'+esc(S.selFrag.text)+'"</p>';
const ch=S.choices[S.selFrag.id];
if(ch){
CATS.forEach(cat=>{
const items=ch[cat.id]||[];
if(items.length){
content+='<div><h4 class="font-bold mb-2">'+cat.i+' '+cat.l+' ('+items.length+')</h4><div class="grid gap-2">';
items.forEach(c=>{content+=renderChoice(c,cat.id)});
content+='</div></div>';
}});
}}else content+='<p class="text-gray-500">Selecteer eerst een fragment</p>';
content+='</div>';
}
else if(S.fullscreen==='scenes'){
title='ğŸ“„ Scenes';
content='<div class="p-6 space-y-4">';
S.scenes.forEach((s,i)=>{
content+='<div class="border rounded-lg p-4"><h4 class="font-bold mb-2">Scene '+(i+1)+(s.name?' - '+esc(s.name):'')+'</h4><pre class="whitespace-pre-wrap text-sm bg-gray-50 dark:bg-gray-700 p-4 rounded max-h-96 overflow-y-auto">'+esc(s.text)+'</pre></div>';
});
if(!S.scenes.length)content+='<p class="text-gray-500">Geen scenes</p>';
content+='</div>';
}

return '<div class="fullscreen-modal" onclick="closeFullscreen()"><div class="fullscreen-content dark:text-gray-200" onclick="event.stopPropagation()"><div class="sticky top-0 bg-white dark:bg-gray-800 border-b p-4 flex justify-between items-center"><h2 class="text-xl font-bold">'+title+'</h2><button onclick="closeFullscreen()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded text-2xl">âœ•</button></div><div class="max-h-[80vh] overflow-y-auto">'+content+'</div></div></div>';
}

function render(){
const app=document.getElementById('app');
let h='';

// Fullscreen modal
h+=renderFullscreen();

// Loading
if(S.loading)h+='<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"><div class="bg-white dark:bg-gray-800 rounded-xl p-6 flex items-center gap-4"><div class="w-8 h-8 border-4 border-purple-600 border-t-transparent rounded-full animate-spin"></div><span class="dark:text-gray-200">'+S.loadMsg+'</span></div></div>';

// Onboarding
if(S.onboard)h+='<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"><div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-lg w-full p-6 max-h-[90vh] overflow-y-auto"><div class="text-center mb-6"><span class="text-6xl">ğŸ­</span><h2 class="text-2xl font-bold mt-4 dark:text-gray-100">Actor\'s Tool V2</h2><p class="text-gray-500">Complete Edition</p></div><div class="space-y-2 text-sm dark:text-gray-300"><p>âœ¨ <b>Nieuw:</b> Sub-keuzes, Geheim Generator, Profielen!</p><p>1ï¸âƒ£ Profiel â†’ 2ï¸âƒ£ Personages â†’ 3ï¸âƒ£ Context</p><p>4ï¸âƒ£ Scene uploaden â†’ 5ï¸âƒ£ Analyseren</p><p>6ï¸âƒ£ Fragment kiezen â†’ 7ï¸âƒ£ Keuzes + Sub-keuzes!</p></div><button onclick="closeOnboard()" class="w-full mt-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg font-semibold">Start! ğŸš€</button></div></div>';

// Header
h+='<header class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-4 shadow-lg"><div class="max-w-7xl mx-auto">';
h+='<div class="flex flex-wrap items-center justify-between gap-4"><div class="flex items-center gap-3"><span class="text-3xl">ğŸ­</span><div><h1 class="text-xl font-bold">Actor\'s Tool V2</h1></div></div>';
h+='<div class="flex items-center gap-2 flex-wrap">';

// Profile buttons
h+='<div class="flex items-center gap-1 bg-white/20 rounded-lg p-1">';
h+='<button onclick="newProject()" class="px-2 py-1 text-xs hover:bg-white/20 rounded" title="Nieuw">ğŸ†•</button>';
h+='<button onclick="saveProfile()" class="px-2 py-1 text-xs hover:bg-white/20 rounded" title="Opslaan">ğŸ’¾</button>';
if(profiles.length){
h+='<select onchange="if(this.value)loadProfile(this.value);this.value=\'\'" class="px-2 py-1 text-xs bg-transparent border-0"><option value="">ğŸ“‚ Laad...</option>';
profiles.forEach(p=>{h+='<option value="'+esc(p.name)+'">'+esc(p.name)+'</option>'});
h+='</select>';
}
h+='</div>';

h+='<select onchange="S.lang=this.value;save();render()" class="px-2 py-1 rounded bg-white/20 text-sm">';
Object.entries(LANG).slice(0,8).forEach(([c,n])=>{h+='<option value="'+c+'"'+(S.lang===c?' selected':'')+' class="text-gray-900">'+n+'</option>'});
h+='</select>';
h+='<button onclick="togDark()" class="p-2 rounded bg-white/20 hover:bg-white/30">'+(S.dark?'â˜€ï¸':'ğŸŒ™')+'</button>';
h+='<button onclick="exportDoc()" class="px-2 py-1 rounded bg-white/20 hover:bg-white/30 text-sm" title="Export document">ğŸ“„</button>';
h+='<button onclick="exportJSON()" class="px-2 py-1 rounded bg-white/20 hover:bg-white/30 text-sm" title="Export JSON">ğŸ“¥</button>';
h+='</div></div>';

// API Key
h+='<div class="mt-3 flex items-center gap-2"><span>ğŸ”‘</span><input type="password" value="'+esc(S.apiKey)+'" onchange="S.apiKey=this.value;localStorage.setItem(\'at_key\',this.value)" placeholder="Claude API Key..." class="flex-1 max-w-xs px-3 py-1 rounded bg-white/20 border border-white/30 placeholder-purple-300 text-sm">'+(S.apiKey?'<span class="text-green-400">âœ“</span>':'')+'</div>';

// Profiles list
if(profiles.length){
h+='<div class="mt-2 flex gap-1 flex-wrap">';
profiles.forEach(p=>{
h+='<div class="flex items-center bg-white/20 rounded text-xs"><button onclick="loadProfile(\''+esc(p.name)+'\')" class="px-2 py-1 hover:bg-white/20">'+esc(p.name)+'</button><button onclick="deleteProfile(\''+esc(p.name)+'\')" class="px-1 py-1 hover:bg-red-500/50 rounded-r">Ã—</button></div>';
});
h+='</div>';
}

h+='</div></header>';

// Main
h+='<main class="max-w-7xl mx-auto p-4"><div class="grid grid-cols-1 lg:grid-cols-12 gap-6">';

// LEFT
h+='<div class="lg:col-span-3 space-y-4">';

// Profile
let prof='<div class="space-y-2"><input type="text" value="'+esc(S.actor.name)+'" onchange="S.actor.name=this.value;save()" placeholder="Naam" class="w-full px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"><div class="grid grid-cols-2 gap-2"><input type="number" value="'+esc(S.actor.age)+'" onchange="S.actor.age=this.value;save()" placeholder="Leeftijd" class="px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"><select onchange="S.actor.build=this.value;save()" class="px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100"><option value="">Postuur...</option>';
BUILD.forEach(b=>{prof+='<option'+(S.actor.build===b?' selected':'')+'>'+b+'</option>'});
prof+='</select></div><textarea onchange="S.actor.notes=this.value;save()" placeholder="Bijzonderheden (blessures etc)..." rows="2" class="w-full px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 text-sm">'+esc(S.actor.notes)+'</textarea></div>';
h+=sec('prof','Actor Profiel','ğŸ‘¤',prof);

// Characters (compact)
let chars='<div class="space-y-2">';
S.chars.forEach((c,i)=>{
chars+='<div class="p-2 bg-gray-50 dark:bg-gray-700 rounded-lg space-y-2"><div class="flex items-center gap-2"><label class="flex items-center gap-1 cursor-pointer '+(c.isMain?'text-purple-600 dark:text-purple-400':'text-gray-500')+'"><input type="checkbox" '+(c.isMain?'checked':'')+' onchange="S.chars.forEach(x=>x.isMain=false);updChar('+c.id+',\'isMain\',this.checked);render()" class="hidden"><span>'+(c.isMain?'â­':'â—‹')+'</span></label><input type="text" value="'+esc(c.name)+'" onchange="updChar('+c.id+',\'name\',this.value)" placeholder="Naam" class="flex-1 px-2 py-1 text-sm border rounded dark:bg-gray-600 dark:border-gray-500 dark:text-gray-100">'+(S.chars.length>1?'<button onclick="remChar('+c.id+')" class="text-red-500 text-sm">âœ•</button>':'')+'</div>';
chars+='<div class="grid grid-cols-2 gap-1">'+dd('r'+c.id,c.rel,c.relC,RELATION,"updChar("+c.id+",'rel',this.value);render()","updChar("+c.id+",'relC',this.value)",'Relatie...')+dd('p'+c.id,c.pow,c.powC,POWER,"updChar("+c.id+",'pow',this.value);render()","updChar("+c.id+",'powC',this.value)",'Macht...')+'</div></div>';
});
if(S.chars.length<6)chars+='<button onclick="addChar()" class="w-full py-2 border-2 border-dashed rounded text-gray-500 hover:border-purple-400 text-sm">â• Personage</button>';
chars+='</div>';
h+=sec('chars','Personages','ğŸ‘¥',chars,S.chars.length+'/6');

// Context compact
let ctx='<div class="space-y-2 text-sm">';
ctx+='<textarea onchange="S.ctx.who=this.value;save()" placeholder="WIE ben je?" rows="1" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">'+esc(S.ctx.who)+'</textarea>';
ctx+='<textarea onchange="S.ctx.what=this.value;save()" placeholder="WAT kom je doen?" rows="1" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">'+esc(S.ctx.what)+'</textarea>';
ctx+='<textarea onchange="S.ctx.why=this.value;save()" placeholder="WAAROM ben je hier?" rows="1" class="w-full px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">'+esc(S.ctx.why)+'</textarea>';
ctx+='<div class="grid grid-cols-2 gap-1">'+dd('ctxw',S.ctx.where,S.ctx.whereC,WHERE,"S.ctx.where=this.value;save();render()","S.ctx.whereC=this.value;save()",'Waar...')+dd('ctxa',S.ctx.atmos,S.ctx.atmosC,ATMOS,"S.ctx.atmos=this.value;save();render()","S.ctx.atmosC=this.value;save()",'Sfeer...')+'</div></div>';
h+=sec('ctx',"Context (5 W's)",'ğŸ“',ctx,'',false);

// Methods compact
let meth='<div class="space-y-2"><div class="max-h-32 overflow-y-auto space-y-1 scrollbar-thin">';
METHODS.slice(0,10).forEach(m=>{
const sel=S.methods.includes(m.id);
meth+='<label class="flex items-center gap-2 p-1 rounded cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 '+(sel?'bg-purple-50 dark:bg-purple-900/30':'')+'"><input type="checkbox" '+(sel?'checked':'')+' onchange="if(this.checked)S.methods.push(\''+m.id+'\');else S.methods=S.methods.filter(x=>x!==\''+m.id+'\');save();render()"><span class="text-xs dark:text-gray-200">'+m.name+'</span></label>';
});
meth+='</div></div>';
h+=sec('meth','Methodes','ğŸ¬',meth,S.methods.length||'',false);

h+='</div>'; // end left

// MIDDLE
h+='<div class="lg:col-span-6 space-y-4">';

// Scene Input
let scene='<div class="space-y-3">';
scene+='<label class="flex items-center justify-center gap-2 px-4 py-3 bg-gradient-to-r from-purple-100 to-indigo-100 dark:from-purple-900/50 dark:to-indigo-900/50 text-purple-700 dark:text-purple-300 rounded-lg cursor-pointer hover:from-purple-200 border-2 border-dashed border-purple-300 dark:border-purple-700"><span>ğŸ“</span><span class="font-medium">Upload</span><span class="text-xs">(TXT/PDF/DOCX)</span><input type="file" accept=".txt,.pdf,.docx" multiple onchange="handleFiles(event)" class="hidden"></label>';

// Show scenes with expand option
if(S.scenes.length){
scene+='<div class="space-y-2">';
S.scenes.forEach((s,i)=>{
const isExp=S.sceneExpanded[s.id];
scene+='<div class="bg-gray-50 dark:bg-gray-700 rounded-lg border-l-4 '+(s.src==='pdf'?'border-red-400':s.src==='docx'?'border-blue-400':'border-purple-400')+'">';
scene+='<div class="flex items-center justify-between p-3 cursor-pointer" onclick="toggleSceneExp('+s.id+')">';
scene+='<div class="flex items-center gap-2"><span>'+(s.src==='pdf'?'ğŸ“•':s.src==='docx'?'ğŸ“˜':'ğŸ“„')+'</span><span class="font-medium dark:text-gray-200">Scene '+(i+1)+'</span>'+(s.name?'<span class="text-xs text-gray-500">'+esc(s.name)+'</span>':'')+'</div>';
scene+='<div class="flex items-center gap-2"><button onclick="event.stopPropagation();remScene('+s.id+')" class="text-red-500 text-sm">ğŸ—‘ï¸</button><span class="text-gray-400">'+(isExp?'â–²':'â–¼')+'</span></div></div>';
if(isExp){
scene+='<div class="px-3 pb-3"><pre class="whitespace-pre-wrap text-sm bg-white dark:bg-gray-800 p-3 rounded max-h-64 overflow-y-auto scrollbar-thin border">'+esc(s.text)+'</pre></div>';
}else{
scene+='<p class="px-3 pb-3 text-sm text-gray-600 dark:text-gray-400 line-clamp-2">'+esc(s.text.substring(0,150))+'...</p>';
}
scene+='</div>';
});
scene+='<button onclick="openFullscreen(\'scenes\')" class="w-full py-1 text-sm text-purple-600 hover:bg-purple-50 dark:hover:bg-purple-900/30 rounded">ğŸ”² Alle scenes fullscreen</button>';
scene+='</div>';
}

scene+='<textarea id="sceneIn" oninput="S.sceneIn=this.value" placeholder="Of plak tekst hier..." rows="3" class="w-full px-3 py-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 text-sm">'+esc(S.sceneIn)+'</textarea>';
scene+='<div class="flex gap-2"><button onclick="S.sceneIn=document.getElementById(\'sceneIn\').value;addScene()" class="flex-1 py-2 bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300 rounded-lg text-sm">â• Toevoegen</button>';
scene+='<button onclick="analyze()" '+(S.scenes.length===0?'disabled':'')+' class="flex-1 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg font-semibold disabled:opacity-50">âœ¨ Analyseer</button></div></div>';
h+=sec('scene','Scene','ğŸ“„',scene,S.scenes.length||'');

// Analysis with fullscreen
if(S.analysis){
let ana='<div class="relative"><button onclick="openFullscreen(\'ana\')" class="absolute top-0 right-0 p-1 text-purple-600 hover:bg-purple-100 rounded" title="Fullscreen">ğŸ”²</button><div class="prose dark:prose-invert max-w-none text-sm max-h-48 overflow-y-auto scrollbar-thin whitespace-pre-wrap pr-8">'+esc(S.analysis)+'</div></div>';
h+=sec('ana','Analyse','ğŸ§ ',ana,'',true,true);
}

// Fragments
if(S.frags.length){
let frags='<div class="space-y-2"><div class="flex gap-1 flex-wrap">';
Object.entries(FRAG).forEach(([t,f])=>{
const cnt=S.frags.filter(x=>x.type===t).length;
frags+='<button onclick="S.fragFilter=\''+t+'\';render()" class="px-2 py-1 text-xs rounded-full '+(S.fragFilter===t?'ring-2 ring-purple-500':'')+' '+f.c+' border">'+f.i+' '+cnt+'</button>';
});
frags+='<button onclick="S.fragFilter=\'all\';render()" class="px-2 py-1 text-xs rounded-full '+(S.fragFilter==='all'?'bg-gray-800 text-white':'bg-gray-200')+'">Alle</button>';
frags+='</div><div class="space-y-1 max-h-40 overflow-y-auto scrollbar-thin">';
S.frags.filter(f=>S.fragFilter==='all'||f.type===S.fragFilter).forEach(f=>{
const info=FRAG[f.type]||FRAG.movement;
frags+='<button onclick="genChoices(S.frags.find(x=>x.id==='+f.id+'))" class="w-full text-left p-2 rounded border '+info.c+' '+(S.selFrag?.id===f.id?'ring-2 ring-purple-500':'')+'"><span class="text-sm">'+esc(f.text)+'</span></button>';
});
frags+='</div></div>';
h+=sec('frags','Fragmenten','ğŸ¨',frags,S.frags.length);
}

// Chat compact
let chat='<div class="space-y-2">';
if(S.chat.length)chat+='<div class="max-h-24 overflow-y-auto space-y-1 scrollbar-thin">'+S.chat.slice(-4).map(m=>'<div class="p-1 rounded text-xs '+(m.role==='user'?'bg-purple-100 dark:bg-purple-900/50':'bg-gray-100 dark:bg-gray-700')+'">'+esc(m.c.substring(0,100))+'...</div>').join('')+'</div>';
chat+='<div class="flex gap-1"><input type="text" id="chatIn" value="'+esc(S.chatIn)+'" oninput="S.chatIn=this.value" onkeydown="if(event.key===\'Enter\'){S.chatIn=this.value;askChat()}" placeholder="Vraag..." class="flex-1 px-2 py-1 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 text-sm"><button onclick="S.chatIn=document.getElementById(\'chatIn\').value;askChat()" class="px-3 py-1 bg-purple-600 text-white rounded text-sm">ğŸ’¬</button></div></div>';
h+=sec('chat','Chat','ğŸ’¬',chat,'',false);

h+='</div>'; // end middle

// RIGHT
h+='<div class="lg:col-span-3 space-y-4">';

// GEHEIM GENERATOR
let secretSec='<div class="space-y-2">';
if(S.secret)secretSec+='<div class="p-2 bg-purple-100 dark:bg-purple-900/50 rounded text-sm"><span class="text-purple-700 dark:text-purple-300">ğŸ”’ '+esc(S.secret)+'</span><button onclick="S.secret=\'\';save();render()" class="float-right text-gray-500">âœ•</button></div>';
secretSec+='<button onclick="genSecrets()" class="w-full py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg text-sm font-medium hover:from-purple-700">ğŸ”’ Genereer 20 Geheimen</button>';
if(S.secretList.length&&S.secretExpanded){
secretSec+='<div class="max-h-48 overflow-y-auto space-y-1 scrollbar-thin border rounded p-2 bg-gray-50 dark:bg-gray-700">';
S.secretList.forEach((s,i)=>{
secretSec+='<button onclick="selectSecret(\''+esc(s).replace(/'/g,"\\'")+'\');event.stopPropagation()" class="w-full text-left p-2 text-xs rounded hover:bg-purple-100 dark:hover:bg-purple-800 '+(S.secret===s?'bg-purple-200 dark:bg-purple-700':'')+'"><span class="text-purple-500">'+(i+1)+'.</span> '+esc(s)+'</button>';
});
secretSec+='</div><button onclick="S.secretExpanded=false;render()" class="w-full text-xs text-gray-500">â–² Inklappen</button>';
}else if(S.secretList.length){
secretSec+='<button onclick="S.secretExpanded=true;render()" class="w-full text-xs text-purple-600">â–¼ Toon '+S.secretList.length+' geheimen</button>';
}
secretSec+='</div>';
h+=sec('secret','Geheim','ğŸ”’',secretSec);

// Wild Card & Famous (direct under buttons)
if(S.selFrag){
let special='<div class="space-y-2">';

// Wild Card
special+='<div><button onclick="wildCard()" class="w-full py-2 bg-orange-500 text-white rounded-lg text-sm font-medium hover:bg-orange-600">ğŸƒ Wild Card</button>';
if(S.wildcard.length&&S.wildcardExp){
special+='<div class="mt-2 max-h-40 overflow-y-auto space-y-1 scrollbar-thin border rounded p-2 bg-orange-50 dark:bg-orange-900/30">';
S.wildcard.forEach(c=>{special+='<div class="p-2 text-xs rounded bg-white dark:bg-gray-800"><span class="font-medium">'+esc(c.choice)+'</span><p class="text-gray-500 mt-1">'+esc(c.why)+'</p></div>'});
special+='</div><button onclick="S.wildcardExp=false;render()" class="w-full text-xs text-gray-500">â–²</button>';
}else if(S.wildcard.length){
special+='<button onclick="S.wildcardExp=true;render()" class="w-full text-xs text-orange-600 mt-1">â–¼ '+S.wildcard.length+' wild cards</button>';
}
special+='</div>';

// Famous
special+='<div><button onclick="famous()" class="w-full py-2 bg-yellow-500 text-white rounded-lg text-sm font-medium hover:bg-yellow-600">â­ Beroemde Keuzes</button>';
if(S.famous.length&&S.famousExp){
special+='<div class="mt-2 max-h-40 overflow-y-auto space-y-1 scrollbar-thin border rounded p-2 bg-yellow-50 dark:bg-yellow-900/30">';
S.famous.forEach(c=>{special+='<div class="p-2 text-xs rounded bg-white dark:bg-gray-800"><span class="font-medium">'+esc(c.actor)+'</span> - '+esc(c.film)+'<p class="mt-1">'+esc(c.choice)+'</p></div>'});
special+='</div><button onclick="S.famousExp=false;render()" class="w-full text-xs text-gray-500">â–²</button>';
}else if(S.famous.length){
special+='<button onclick="S.famousExp=true;render()" class="w-full text-xs text-yellow-600 mt-1">â–¼ '+S.famous.length+' beroemde keuzes</button>';
}
special+='</div>';

special+='</div>';
h+=sec('special','Speciale Keuzes','âœ¨',special);
}

// Choices with fullscreen button
if(S.selFrag&&S.choices[S.selFrag.id]){
let ch='<div class="space-y-2"><div class="flex justify-between items-center"><p class="text-xs text-gray-500 truncate flex-1">"'+esc(S.selFrag.text.substring(0,30))+'..."</p><button onclick="openFullscreen(\'choices\')" class="text-purple-600 text-sm" title="Fullscreen">ğŸ”²</button></div>';
ch+='<p class="text-xs text-purple-600 italic">ğŸ’¡ Klik keuze voor sub-keuzes</p>';
CATS.forEach(cat=>{
const items=S.choices[S.selFrag.id][cat.id]||[];
if(items.length){
const exp=S.expanded['ch_'+cat.id];
const show=exp?items:items.slice(0,4);
ch+='<div><h4 class="text-xs font-medium text-gray-500 mb-1">'+cat.i+' '+cat.l+' ('+items.length+')</h4><div class="space-y-1">';
show.forEach(c=>{ch+=renderChoice(c,cat.id)});
if(items.length>4)ch+='<button onclick="S.expanded[\'ch_'+cat.id+'\']=!S.expanded[\'ch_'+cat.id+'\'];render()" class="w-full text-xs text-purple-600">'+(exp?'â–² Minder':'â–¼ Alle '+items.length)+'</button>';
ch+='</div></div>';
}});
ch+='</div>';
h+=sec('choices','Keuzes','âœ¨',ch,'',true,true);
}

// Favorites compact
let fav=S.favs.length?'<div class="max-h-24 overflow-y-auto space-y-1 scrollbar-thin">'+S.favs.slice(0,5).map(f=>'<div class="p-1 bg-pink-50 dark:bg-pink-900/30 rounded flex justify-between text-xs"><span class="truncate">'+esc(f.choice.substring(0,40))+'...</span><button onclick="togFav(\''+esc(f.choice).replace(/'/g,"\\'")+'\',\'\')" class="text-red-500">âœ•</button></div>').join('')+(S.favs.length>5?'<p class="text-xs text-gray-500">+'+(S.favs.length-5)+' meer</p>':'')+'</div>':'<p class="text-xs text-gray-500 italic">Geen favorieten</p>';
h+=sec('favs','Favorieten','â¤ï¸',fav,S.favs.length||'',false);

// Timer compact
const m=Math.floor(S.rehTime/60),ss=S.rehTime%60;
let reh='<div class="text-center"><span class="text-2xl font-mono font-bold text-purple-600">'+m+':'+(ss<10?'0':'')+ss+'</span><div class="flex gap-1 justify-center mt-2">';
if(!S.rehActive)reh+='<button onclick="startReh()" class="px-3 py-1 bg-green-500 text-white rounded text-sm">â–¶ï¸</button>';
else reh+='<button onclick="stopReh()" class="px-3 py-1 bg-red-500 text-white rounded text-sm">â¸ï¸</button>';
reh+='<button onclick="resetReh()" class="px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded text-sm">ğŸ”„</button></div></div>';
h+=sec('reh','Timer','â±ï¸',reh,'',false);

h+='</div>'; // end right
h+='</div></main>';

app.innerHTML=h;
}

render();
if('serviceWorker' in navigator)navigator.serviceWorker.register('sw.js').catch(()=>{});
</script>
</body>
</html>
